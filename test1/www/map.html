<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link href="lib/ionic/css/ionic.css" rel="stylesheet">
    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css"/>
    <script src="http://webapi.amap.com/maps?v=1.3&key=b525aaba2a78eef9d75408b9ec8b967d"></script>
    <script src="js/zepto.min.js"></script>

    <style>


        #searchStat {
            z-index: 99;
            padding: 0;
            border: 0px solid silver;
            position: absolute;
            top: 85vh;
            right: 5vh;

        }

        #showMyPos {
            z-index: 99;
            padding: 0;
            border: 0px solid silver;
            position: absolute;
            top: 85vh;
            left: 2vh;

        }
    </style>
</head>
<body style="overflow: hidden;margin: 0;padding: 0;">

<div id="container">


</div>
<div id="searchStat">
<span onclick="refreshInfo ();" style="font-size: 25px;" class="ion-refresh" data-pack="default"
      data-tags="gps, navigation, pin"></span>
</div>
<div id="showMyPos">
<span onclick="showCurrentGps();" style="font-size: 25px;" class="ion-navigate" data-pack="default"
      data-tags="gps, navigation, pin"></span>
</div>
</body>
<script>

    var map, carMark;
    function onDeviceReady() {
        console.log("deviceready works well");
        if(typeof AMap == 'undefined'){
            window.location.reload();
        }else{
            map = new AMap.Map('container', {
                resizeEnable: true,
                //center: {},
                zoom: 16
            });
            init();
        }

    }
    if (!window.device) {
        window.onload = onDeviceReady;
        console.log('===>> window.device');
    } else {
        document.addEventListener("deviceready", onDeviceReady, true);
         console.log('===>> document.addEventListener');
    }

    function postmessageFunc(info) {
        window.parent.postMessage(info, "*");
    }

    window.addEventListener('message', function (event) {
        if (event.source == window)
            return;
        //确保发送消息的域名是已知的域名
        var msg = event.data["msgKey"];
        AMap.convertFrom(event.data.data,'gps',function(status,result){
            if(status="complete"){
                postObj()[msg](result["locations"][0]);
            }else{
                alert(result);
            }
        });

    });



    var postObj = function(){
        var initMap = function (position) {
            var pos = [position.lng, position.lat];
            carMark = new AMap.Marker({
                icon: "img/car.png",
                position: pos
            });
            carMark.setMap(map);
            map.setCenter(pos);
        };
        var carMove = function (position) {
            var pos = [position.lng, position.lat];
            if(!carMark){
                carMark = new AMap.Marker({
                    icon: "img/car.png",
                    position:[116.397428, 39.90923]
                });
                carMark.setMap(map);
            }
            carMark.setPosition(pos);
            map.setCenter(pos);
        };
        var gpsGetError = function onError(error) {
            alert('code: ' + error.code + '\n' +
            'message: ' + error.message + '\n');
        };

        return {"carMove":carMove,"gpsGetError":gpsGetError,"initMap":initMap};
    };

    function showCurrentGps() {
        var info = {"msgKey": "carMove"};
        postmessageFunc(info);
    }
    function init() {
        var info = {"msgKey": "initMap"};
        postmessageFunc(info);
    }



    function refreshInfo() {
        alert('refreshInfo');

        Zepto.ajax({
            type: 'GET',
            url: 'http://restapi.amap.com/v3/assistant/coordinate/convert',
            data: 'locations=108.92465692120639,34.21819530755288&coordsys=gps&key=1641d880ed8778250a8d78a20fe0c48d',
            dataType: 'json',
            timeout: 5000,
            success: function (data) {
                alert(data);
            },
            beforeSend:function(){

            },
            complete:function(){

            },
            error: function (xhr, type) {
                alert('ERROR!'+type );

            }
        });


    }


</script>

</html>
